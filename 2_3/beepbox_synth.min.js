var beepbox;!function(t){function i(t){if(!function(t){return!(!t||t&t-1)}(t))throw new Error("FFT array length must be a power of 2.");return Math.round(Math.log(t)/Math.log(2))}t.scaleElementsByFactor=function(t,i){for(var s=0;s<t.length;s++)t[s]*=i},t.inverseRealFourierTransform=function(t){var s=t.length,h=i(s);if(s<4)throw new Error("FFT array length must be at least 4.");for(var r=h-1;r>=2;r--)for(var e=1<<r,a=e>>1,n=e<<1,o=2*Math.PI/n,f=Math.cos(o),l=Math.sin(o),u=2*f,v=0;v<s;v+=n){var c=v,d=c+a,p=c+e,M=p+a,b=p+e,m=t[c],w=t[p];t[c]=m+w,t[d]*=2,t[p]=m-w,t[M]*=2;for(var y=f,g=-l,x=1,S=0,k=1;k<a;k++){var O=c+k,E=p-k,P=p+k,I=b-k,A=t[O],D=t[E],F=t[P],T=t[I],R=A-D,B=F+T;t[O]=A+D,t[E]=T-F,t[P]=R*y-B*g,t[I]=B*y+R*g;var U=u*y-x,Y=u*g-S;x=y,S=g,y=U,g=Y}}for(k=0;k<s;k+=4){var C=k+1,z=k+2,j=k+3,q=(A=t[k],D=2*t[C],t[z]),N=2*t[j];R=A+q,B=A-q,t[k]=R+D,t[C]=R-D,t[z]=B+N,t[j]=B-N}!function(t){var s=t.length,h=i(s);if(h>16)throw new Error("FFT array length must not be greater than 2^16.");for(var r=16-h,e=0;e<s;e++){var a=void 0;if((a=((a=(61680&(a=(52428&(a=(43690&e)>>1|(21845&e)<<1))>>2|(13107&a)<<2))>>4|(3855&a)<<4)>>8|(255&a)<<8)>>r)>e){var n=t[e];t[e]=t[a],t[a]=n}}}(t)}}(beepbox||(beepbox={})),function(t){var i=function(){function i(){}return i.t=function(t){for(var i=0,s=0;s<t.length;s++)i+=t[s];var h=i/t.length;for(s=0;s<t.length;s++)t[s]-=h;return new Float64Array(t)},i.getDrumWave=function(s){var h=i.i[s];if(null==h)if(h=new Float32Array(32768),i.i[s]=h,0==s)for(var r=1,e=0;e<32768;e++){h[e]=2*(1&r)-1,1==(r+(a=r>>1)&1)&&(a+=16384),r=a}else if(1==s)for(e=0;e<32768;e++)h[e]=2*Math.random()-1;else if(2==s)for(r=1,e=0;e<32768;e++){h[e]=2*(1&r)-1,1==(r+(a=r>>1)&1)&&(a+=32768),r=a}else if(3==s)for(r=1,e=0;e<32768;e++){var a;h[e]=2*(1&r)-1,1==(r+(a=r>>1)&1)&&(a+=40),r=a}else{if(4!=s)throw new Error("Unrecognized drum index: "+s);i.drawNoiseSpectrum(h,10,11,1,1,0),i.drawNoiseSpectrum(h,11,14,-2,-2,0),t.inverseRealFourierTransform(h),t.scaleElementsByFactor(h,1/Math.sqrt(h.length))}return h},i.drawNoiseSpectrum=function(t,i,s,h,r,e){for(var a=0|Math.pow(2,i),n=0|Math.pow(2,s),o=Math.log(2),f=a;f<n;f++){var l=Math.pow(2,h+(r-h)*(Math.log(f)/o-i)/(s-i));l*=Math.pow(f/2048,e);var u=Math.random()*Math.PI*2;t[f]=Math.cos(u)*l,t[32768-f]=Math.sin(u)*l}},i.generateSineWave=function(){for(var t=new Float64Array(i.sineWaveLength+1),s=0;s<i.sineWaveLength+1;s++)t[s]=Math.sin(s*Math.PI*2/i.sineWaveLength);return t},i.scaleNames=["easy :)","easy :(","island :)","island :(","blues :)","blues :(","normal :)","normal :(","dbl harmonic :)","dbl harmonic :(","enigma","expert"],i.scaleFlags=[[!0,!1,!0,!1,!0,!1,!1,!0,!1,!0,!1,!1],[!0,!1,!1,!0,!1,!0,!1,!0,!1,!1,!0,!1],[!0,!1,!1,!1,!0,!0,!1,!0,!1,!1,!1,!0],[!0,!0,!1,!0,!1,!1,!1,!0,!0,!1,!1,!1],[!0,!1,!0,!0,!0,!1,!1,!0,!1,!0,!1,!1],[!0,!1,!1,!0,!1,!0,!0,!0,!1,!1,!0,!1],[!0,!1,!0,!1,!0,!0,!1,!0,!1,!0,!1,!0],[!0,!1,!0,!0,!1,!0,!1,!0,!0,!1,!0,!1],[!0,!0,!1,!1,!0,!0,!1,!0,!0,!1,!1,!0],[!0,!1,!0,!0,!1,!1,!0,!0,!0,!1,!1,!0],[!0,!1,!0,!1,!0,!1,!0,!1,!0,!1,!0,!1],[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0]],i.pianoScaleFlags=[!0,!1,!0,!1,!0,!0,!1,!0,!1,!0,!1,!0],i.blackKeyNameParents=[-1,1,-1,1,-1,1,-1,-1,1,-1,1,-1],i.pitchNames=["C",null,"D",null,"E","F",null,"G",null,"A",null,"B"],i.keyNames=["B","A♯","A","G♯","G","F♯","F","E","D♯","D","C♯","C"],i.keyTransposes=[23,22,21,20,19,18,17,16,15,14,13,12],i.tempoSteps=15,i.reverbRange=4,i.beatsPerBarMin=3,i.beatsPerBarMax=16,i.barCountMin=1,i.barCountMax=128,i.patternsPerChannelMin=1,i.patternsPerChannelMax=64,i.instrumentsPerChannelMin=1,i.instrumentsPerChannelMax=10,i.partNames=["÷3 (triplets)","÷4 (standard)","÷6","÷8"],i.partCounts=[3,4,6,8],i.waveNames=["triangle","square","pulse wide","pulse narrow","sawtooth","double saw","double pulse","spiky","plateau"],i.waveVolumes=[1,.5,.5,.5,.65,.5,.4,.4,.94],i.drumNames=["retro","white","clang","buzz","hollow"],i.drumVolumes=[.25,1,.4,.3,1.5],i.drumBasePitches=[69,69,69,69,96],i.drumPitchFilterMult=[100,8,100,100,1],i.drumWaveIsSoft=[!1,!0,!1,!1,!0],i.i=[null,null,null,null,null],i.filterNames=["none","bright","medium","soft","decay bright","decay medium","decay soft"],i.filterBases=[0,2,3.5,5,1,2.5,4],i.filterDecays=[0,0,0,0,10,7,4],i.filterVolumes=[.2,.4,.7,1,.5,.75,1],i.transitionNames=["seamless","sudden","smooth","slide"],i.effectNames=["none","vibrato light","vibrato delayed","vibrato heavy","tremolo light","tremolo heavy"],i.effectVibratos=[0,.15,.3,.45,0,0],i.effectTremolos=[0,0,0,0,.25,.5],i.effectVibratoDelays=[0,0,3,0,0,0],i.chorusNames=["union","shimmer","hum","honky tonk","dissonant","fifths","octaves","bowed","custom harmony"],i.chorusIntervals=[0,.02,.05,.1,.25,3.5,6,.02,.05],i.chorusOffsets=[0,0,0,0,0,3.5,6,0,0],i.chorusVolumes=[.7,.8,1,1,.9,.9,.8,1,1],i.chorusSigns=[1,1,1,1,1,1,1,-1,1],i.chorusHarmonizes=[!1,!1,!1,!1,!1,!1,!1,!1,!0],i.volumeNames=["loudest","loud","medium","quiet","quietest","mute"],i.volumeValues=[0,.5,1,1.5,2,-1],i.operatorCount=4,i.operatorAlgorithmNames=["1←(2 3 4)","1←(2 3←4)","1←2←(3 4)","1←(2 3)←4","1←2←3←4","1←3 2←4","1 2←(3 4)","1 2←3←4","(1 2)←3←4","(1 2)←(3 4)","1 2 3←4","(1 2 3)←4","1 2 3 4"],i.midiAlgorithmNames=["1<(2 3 4)","1<(2 3<4)","1<2<(3 4)","1<(2 3)<4","1<2<3<4","1<3 2<4","1 2<(3 4)","1 2<3<4","(1 2)<3<4","(1 2)<(3 4)","1 2 3<4","(1 2 3)<4","1 2 3 4"],i.operatorModulatedBy=[[[2,3,4],[],[],[]],[[2,3],[],[4],[]],[[2],[3,4],[],[]],[[2,3],[4],[4],[]],[[2],[3],[4],[]],[[3],[4],[],[]],[[],[3,4],[],[]],[[],[3],[4],[]],[[3],[3],[4],[]],[[3,4],[3,4],[],[]],[[],[],[4],[]],[[4],[4],[4],[]],[[],[],[],[]]],i.operatorAssociatedCarrier=[[1,1,1,1],[1,1,1,1],[1,1,1,1],[1,1,1,1],[1,1,1,1],[1,2,1,2],[1,2,2,2],[1,2,2,2],[1,2,2,2],[1,2,2,2],[1,2,3,3],[1,2,3,3],[1,2,3,4]],i.operatorCarrierCounts=[1,1,1,1,1,2,2,2,2,2,3,3,4],i.operatorCarrierChorus=[0,.04,-.073,.091],i.operatorAmplitudeMax=15,i.operatorFrequencyNames=["1×","~1×","2×","~2×","3×","4×","5×","6×","7×","8×","9×","11×","13×","16×","20×"],i.midiFrequencyNames=["1x","~1x","2x","~2x","3x","4x","5x","6x","7x","8x","9x","11x","13x","16x","20x"],i.operatorFrequencies=[1,1,2,2,3,4,5,6,7,8,9,11,13,16,20],i.operatorHzOffsets=[0,1.5,0,-1.3,0,0,0,0,0,0,0,0,0,0,0],i.operatorAmplitudeSigns=[1,-1,1,-1,1,1,1,1,1,1,1,1,1,1,1],i.operatorEnvelopeNames=["custom","steady","punch","flare 1","flare 2","flare 3","pluck 1","pluck 2","pluck 3","swell 1","swell 2","swell 3","tremolo1","tremolo2","tremolo3"],i.operatorEnvelopeType=[0,1,2,3,3,3,4,4,4,4,4,4,5,5,5],i.operatorEnvelopeSpeed=[0,0,0,32,8,2,32,8,2,32,8,2,4,2,1],i.operatorEnvelopeInverted=[!1,!1,!1,!1,!1,!1,!1,!1,!1,!0,!0,!0,!1,!1,!1],i.operatorFeedbackNames=["1⟲","2⟲","3⟲","4⟲","1⟲ 2⟲","3⟲ 4⟲","1⟲ 2⟲ 3⟲","2⟲ 3⟲ 4⟲","1⟲ 2⟲ 3⟲ 4⟲","1→2","1→3","1→4","2→3","2→4","3→4","1→3 2→4","1→4 2→3","1→2→3→4"],i.midiFeedbackNames=["1","2","3","4","1 2","3 4","1 2 3","2 3 4","1 2 3 4","1>2","1>3","1>4","2>3","2>4","3>4","1>3 2>4","1>4 2>3","1>2>3>4"],i.operatorFeedbackIndices=[[[1],[],[],[]],[[],[2],[],[]],[[],[],[3],[]],[[],[],[],[4]],[[1],[2],[],[]],[[],[],[3],[4]],[[1],[2],[3],[]],[[],[2],[3],[4]],[[1],[2],[3],[4]],[[],[1],[],[]],[[],[],[1],[]],[[],[],[],[1]],[[],[],[2],[]],[[],[],[],[2]],[[],[],[],[3]],[[],[],[1],[2]],[[],[],[2],[1]],[[],[1],[2],[3]]],i.pitchChannelTypeNames=["chip","FM (expert)"],i.instrumentTypeNames=["chip","FM","noise"],i.pitchChannelColorsDim=["#0099a1","#a1a100","#c75000","#00a100","#d020d0","#7777b0"],i.pitchChannelColorsBright=["#25f3ff","#ffff25","#ff9752","#50ff50","#ff90ff","#a0a0ff"],i.pitchNoteColorsDim=["#00bdc7","#c7c700","#ff771c","#00c700","#e040e0","#8888d0"],i.pitchNoteColorsBright=["#92f9ff","#ffff92","#ffcdab","#a0ffa0","#ffc0ff","#d0d0ff"],i.drumChannelColorsDim=["#6f6f6f","#996633"],i.drumChannelColorsBright=["#aaaaaa","#ddaa77"],i.drumNoteColorsDim=["#aaaaaa","#cc9966"],i.drumNoteColorsBright=["#eeeeee","#f0d0bb"],i.midiPitchChannelNames=["cyan channel","yellow channel","orange channel","green channel","purple channel","blue channel"],i.midiDrumChannelNames=["gray channel","brown channel"],i.midiSustainInstruments=[71,80,70,68,81,81,81,81,74],i.midiDecayInstruments=[46,46,6,24,25,25,106,106,33],i.drumInterval=6,i.drumCount=12,i.pitchCount=37,i.maxPitch=84,i.pitchChannelCountMin=1,i.pitchChannelCountMax=6,i.drumChannelCountMin=0,i.drumChannelCountMax=2,i.waves=[i.t([1/15,.2,5/15,7/15,.6,11/15,13/15,1,1,13/15,11/15,.6,7/15,5/15,.2,1/15,-1/15,-.2,-5/15,-7/15,-.6,-11/15,-13/15,-1,-1,-13/15,-11/15,-.6,-7/15,-5/15,-.2,-1/15]),i.t([1,-1]),i.t([1,-1,-1,-1]),i.t([1,-1,-1,-1,-1,-1,-1,-1]),i.t([1/31,3/31,5/31,7/31,9/31,11/31,13/31,15/31,17/31,19/31,21/31,23/31,25/31,27/31,29/31,1,-1,-29/31,-27/31,-25/31,-23/31,-21/31,-19/31,-17/31,-15/31,-13/31,-11/31,-9/31,-7/31,-5/31,-3/31,-1/31]),i.t([0,-.2,-.4,-.6,-.8,-1,1,-.8,-.6,-.4,-.2,1,.8,.6,.4,.2]),i.t([1,1,1,1,1,-1,-1,-1,1,1,1,1,-1,-1,-1,-1]),i.t([1,-1,1,-1,1,0]),i.t([0,.2,.4,.5,.6,.7,.8,.85,.9,.95,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,.95,.9,.85,.8,.7,.6,.5,.4,.2,0,-.2,-.4,-.5,-.6,-.7,-.8,-.85,-.9,-.95,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-.95,-.9,-.85,-.8,-.7,-.6,-.5,-.4,-.2])],i.sineWaveLength=256,i.sineWaveMask=i.sineWaveLength-1,i.sineWave=i.generateSineWave(),i}();t.Config=i;var s=function(){function t(t,i,s,h){this.s=[],this.h=0;for(var r=s;r<h;r++){var e=t[i.charCodeAt(r)];this.s.push(e>>5&1),this.s.push(e>>4&1),this.s.push(e>>3&1),this.s.push(e>>2&1),this.s.push(e>>1&1),this.s.push(1&e)}}return t.prototype.read=function(t){for(var i=0;t>0;)i<<=1,i+=this.s[this.h++],t--;return i},t.prototype.readLongTail=function(t,i){for(var s=t,h=i;this.s[this.h++];)s+=1<<h,h++;for(;h>0;)h--,this.s[this.h++]&&(s+=1<<h);return s},t.prototype.readPartDuration=function(){return this.readLongTail(1,2)},t.prototype.readPinCount=function(){return this.readLongTail(1,0)},t.prototype.readPitchInterval=function(){return this.read(1)?-this.readLongTail(1,3):this.readLongTail(1,3)},t}(),h=function(){function t(){this.s=[]}return t.prototype.write=function(t,i){for(t--;t>=0;)this.s.push(i>>>t&1),t--},t.prototype.writeLongTail=function(t,i,s){if(s<t)throw new Error("value out of bounds");s-=t;for(var h=i;s>=1<<h;)this.s.push(1),s-=1<<h,h++;for(this.s.push(0);h>0;)h--,this.s.push(s>>>h&1)},t.prototype.writePartDuration=function(t){this.writeLongTail(1,2,t)},t.prototype.writePinCount=function(t){this.writeLongTail(1,0,t)},t.prototype.writePitchInterval=function(t){t<0?(this.write(1,1),this.writeLongTail(1,3,-t)):(this.write(1,0),this.writeLongTail(1,3,t))},t.prototype.concat=function(t){this.s=this.s.concat(t.s)},t.prototype.encodeBase64=function(t,i){for(var s=0;s<this.s.length;s+=6){var h=this.s[s]<<5|this.s[s+1]<<4|this.s[s+2]<<3|this.s[s+3]<<2|this.s[s+4]<<1|this.s[s+5];i.push(t[h])}return i},t.prototype.lengthBase64=function(){return Math.ceil(this.s.length/6)},t}();function r(t,i,s){return{interval:t,time:i,volume:s}}function e(t,i,s,h,e){return void 0===e&&(e=!1),{pitches:[t],pins:[r(0,0,h),r(0,s-i,e?0:h)],start:i,end:s}}t.makeNotePin=r,t.makeNote=e;var a=function(){function t(){this.notes=[],this.instrument=0}return t.prototype.cloneNotes=function(){for(var t=[],i=0,s=this.notes;i<s.length;i++){var h=s[i],a=e(-1,h.start,h.end,3);a.pitches=h.pitches.concat(),a.pins=[];for(var n=0,o=h.pins;n<o.length;n++){var f=o[n];a.pins.push(r(f.interval,f.time,f.volume))}t.push(a)}return t},t.prototype.reset=function(){this.notes.length=0,this.instrument=0},t}();t.Pattern=a;var n=function(){function t(t){this.frequency=0,this.amplitude=0,this.envelope=0,this.reset(t)}return t.prototype.reset=function(t){this.frequency=0,this.amplitude=t<=1?i.operatorAmplitudeMax:0,this.envelope=0==t?0:1},t.prototype.copy=function(t){this.frequency=t.frequency,this.amplitude=t.amplitude,this.envelope=t.envelope},t}();t.Operator=n;var o=function(){function t(){this.type=0,this.wave=1,this.filter=1,this.transition=1,this.effect=0,this.chorus=0,this.volume=0,this.algorithm=0,this.feedbackType=0,this.feedbackAmplitude=0,this.feedbackEnvelope=1,this.operators=[];for(var t=0;t<i.operatorCount;t++)this.operators.push(new n(t))}return t.prototype.setTypeAndReset=function(t){switch(this.type=t,t){case 0:this.wave=1,this.filter=1,this.transition=1,this.effect=0,this.chorus=0,this.volume=0;break;case 1:this.wave=1,this.transition=1,this.volume=0;break;case 2:this.transition=1,this.effect=0,this.algorithm=0,this.feedbackType=0,this.feedbackAmplitude=0,this.feedbackEnvelope=1;for(var i=0;i<this.operators.length;i++)this.operators[i].reset(i)}},t.prototype.copy=function(t){this.type=t.type,this.wave=t.wave,this.filter=t.filter,this.transition=t.transition,this.effect=t.effect,this.chorus=t.chorus,this.volume=t.volume,this.algorithm=t.algorithm,this.feedbackType=t.feedbackType,this.feedbackAmplitude=t.feedbackAmplitude,this.feedbackEnvelope=t.feedbackEnvelope;for(var i=0;i<this.operators.length;i++)this.operators[i].copy(t.operators[i])},t}();t.Instrument=o;var f=function(){return function(){this.octave=0,this.instruments=[],this.patterns=[],this.bars=[]}}();t.Channel=f;var l=function(){function t(t){this.channels=[],void 0!=t?this.fromBase64String(t):this.initToDefault(!0)}return t.prototype.getChannelCount=function(){return this.pitchChannelCount+this.drumChannelCount},t.prototype.getChannelIsDrum=function(t){return t>=this.pitchChannelCount},t.prototype.getChannelColorDim=function(t){return t<this.pitchChannelCount?i.pitchChannelColorsDim[t]:i.drumChannelColorsDim[t-this.pitchChannelCount]},t.prototype.getChannelColorBright=function(t){return t<this.pitchChannelCount?i.pitchChannelColorsBright[t]:i.drumChannelColorsBright[t-this.pitchChannelCount]},t.prototype.getNoteColorDim=function(t){return t<this.pitchChannelCount?i.pitchNoteColorsDim[t]:i.drumNoteColorsDim[t-this.pitchChannelCount]},t.prototype.getNoteColorBright=function(t){return t<this.pitchChannelCount?i.pitchNoteColorsBright[t]:i.drumNoteColorsBright[t-this.pitchChannelCount]},t.prototype.initToDefault=function(t){if(void 0===t&&(t=!0),this.scale=0,this.key=i.keyNames.length-1,this.loopStart=0,this.loopLength=4,this.tempo=7,this.reverb=0,this.beatsPerBar=8,this.barCount=16,this.patternsPerChannel=8,this.partsPerBeat=4,this.instrumentsPerChannel=1,t){this.pitchChannelCount=3,this.drumChannelCount=1;for(var s=0;s<this.getChannelCount();s++){this.channels.length<=s&&(this.channels[s]=new f);var h=this.channels[s];h.octave=3-s;for(var r=0;r<this.patternsPerChannel;r++)h.patterns.length<=r?h.patterns[r]=new a:h.patterns[r].reset();h.patterns.length=this.patternsPerChannel;for(var e=0;e<this.instrumentsPerChannel;e++)h.instruments.length<=e&&(h.instruments[e]=new o),h.instruments[e].setTypeAndReset(s<this.pitchChannelCount?0:2);h.instruments.length=this.instrumentsPerChannel;for(var n=0;n<this.barCount;n++)h.bars[n]=1;h.bars.length=this.barCount}this.channels.length=this.getChannelCount()}},t.prototype.toBase64String=function(){var s,r=[],e=t.o;r.push(e[t.l]),r.push(110,e[this.pitchChannelCount],e[this.drumChannelCount]),r.push(115,e[this.scale]),r.push(107,e[this.key]),r.push(108,e[this.loopStart>>6],e[63&this.loopStart]),r.push(101,e[this.loopLength-1>>6],e[this.loopLength-1&63]),r.push(116,e[this.tempo]),r.push(109,e[this.reverb]),r.push(97,e[this.beatsPerBar-1]),r.push(103,e[this.barCount-1>>6],e[this.barCount-1&63]),r.push(106,e[this.patternsPerChannel-1]),r.push(105,e[this.instrumentsPerChannel-1]),r.push(114,e[i.partCounts.indexOf(this.partsPerBeat)]),r.push(111);for(var a=0;a<this.getChannelCount();a++)r.push(e[this.channels[a].octave]);for(a=0;a<this.getChannelCount();a++)for(var n=0;n<this.instrumentsPerChannel;n++){var o=this.channels[a].instruments[n];if(r.push(84,e[o.type]),0==o.type)r.push(119,e[o.wave]),r.push(102,e[o.filter]),r.push(100,e[o.transition]),r.push(99,e[o.effect]),r.push(104,e[o.chorus]),r.push(118,e[o.volume]);else if(1==o.type){r.push(100,e[o.transition]),r.push(99,e[o.effect]),r.push(65,e[o.algorithm]),r.push(70,e[o.feedbackType]),r.push(66,e[o.feedbackAmplitude]),r.push(86,e[o.feedbackEnvelope]),r.push(81);for(var f=0;f<i.operatorCount;f++)r.push(e[o.operators[f].frequency]);r.push(80);for(f=0;f<i.operatorCount;f++)r.push(e[o.operators[f].amplitude]);r.push(69);for(f=0;f<i.operatorCount;f++)r.push(e[o.operators[f].envelope])}else{if(2!=o.type)throw new Error("Unknown instrument type.");r.push(119,e[o.wave]),r.push(100,e[o.transition]),r.push(118,e[o.volume])}}r.push(98),s=new h;for(var l=0;1<<l<this.patternsPerChannel+1;)l++;for(a=0;a<this.getChannelCount();a++)for(n=0;n<this.barCount;n++)s.write(l,this.channels[a].bars[n]);s.encodeBase64(e,r),r.push(112),s=new h;for(var u=0;1<<u<this.instrumentsPerChannel;)u++;for(a=0;a<this.getChannelCount();a++){var v=this.getChannelIsDrum(a),c=v?0:12*this.channels[a].octave,d=(v?4:12)+c,p=v?[4,6,7,2,3,8,0,10]:[12,19,24,31,36,7,0],M=[];for(n=0;n<p.length;n++)p[n]+=c;for(var b=0,m=this.channels[a].patterns;b<m.length;b++){var w=m[b];if(s.write(u,w.instrument),w.notes.length>0){s.write(1,1);for(var y=0,g=0,x=w.notes;g<x.length;g++){var S=x[g];S.start>y&&(s.write(2,0),s.writePartDuration(S.start-y));var k=new h;for(n=1;n<S.pitches.length;n++)k.write(1,1);S.pitches.length<4&&k.write(1,0),k.writePinCount(S.pins.length-1),k.write(2,S.pins[0].volume);var O=0,E=S.pitches[0],P=E,I=[];for(n=1;n<S.pins.length;n++){var A=S.pins[n],D=E+A.interval;P!=D?(k.write(1,1),I.push(D),P=D):k.write(1,0),k.writePartDuration(A.time-O),O=A.time,k.write(2,A.volume)}var F=String.fromCharCode.apply(null,k.encodeBase64(e,[])),T=M.indexOf(F);-1==T?(s.write(2,1),s.concat(k)):(s.write(1,1),s.writeLongTail(0,0,T),M.splice(T,1)),M.unshift(F),M.length>10&&M.pop();var R=S.pitches.concat(I);for(n=0;n<R.length;n++){var B=R[n],U=p.indexOf(B);if(-1==U){var Y=0,C=d;if(C<B)for(;C!=B;)C++,-1==p.indexOf(C)&&Y++;else for(;C!=B;)C--,-1==p.indexOf(C)&&Y--;s.write(1,0),s.writePitchInterval(Y)}else s.write(1,1),s.write(3,U),p.splice(U,1);p.unshift(B),p.length>8&&p.pop(),d=n==S.pitches.length-1?S.pitches[0]:B}y=S.end}y<this.beatsPerBar*this.partsPerBeat&&(s.write(2,0),s.writePartDuration(this.beatsPerBar*this.partsPerBeat-y))}else s.write(1,0)}}for(var z=s.lengthBase64(),j=[];z>0;)j.unshift(e[63&z]),z>>=6;if(r.push(e[j.length]),Array.prototype.push.apply(r,j),s.encodeBase64(e,r),r.length>=65535)throw new Error("Song hash code too long.");return String.fromCharCode.apply(null,r)},t.prototype.fromBase64String=function(h){if(null!=h&&""!=h){for(var n=0;h.charCodeAt(n)<=32;)n++;if(35==h.charCodeAt(n)&&n++,123!=h.charCodeAt(n)){var l=t.u[h.charCodeAt(n++)];if(!(-1==l||l>t.l||l<t.v)){var u=l<3,v=l<4,c=l<5,d=l<6,p=t.u;if(this.initToDefault(d),u){for(var M=0,b=this.channels;M<b.length;M++){(g=b[M]).instruments[0].transition=0}this.channels[3].instruments[0].wave=0}for(var m=0,w=-1;n<h.length;){var y=h.charCodeAt(n++),g=void 0;if(110==y){this.pitchChannelCount=p[h.charCodeAt(n++)],this.drumChannelCount=p[h.charCodeAt(n++)],this.pitchChannelCount=t.p(i.pitchChannelCountMin,i.pitchChannelCountMax+1,this.pitchChannelCount),this.drumChannelCount=t.p(i.drumChannelCountMin,i.drumChannelCountMax+1,this.drumChannelCount);for(var x=this.channels.length;x<this.getChannelCount();x++)this.channels[x]=new f;this.channels.length=this.getChannelCount()}else if(115==y)this.scale=p[h.charCodeAt(n++)],u&&10==this.scale&&(this.scale=11);else if(107==y)this.key=p[h.charCodeAt(n++)];else if(108==y)this.loopStart=c?p[h.charCodeAt(n++)]:(p[h.charCodeAt(n++)]<<6)+p[h.charCodeAt(n++)];else if(101==y)this.loopLength=c?p[h.charCodeAt(n++)]:(p[h.charCodeAt(n++)]<<6)+p[h.charCodeAt(n++)]+1;else if(116==y)this.tempo=v?[1,4,7,10][p[h.charCodeAt(n++)]]:p[h.charCodeAt(n++)],this.tempo=t.p(0,i.tempoSteps,this.tempo);else if(109==y)this.reverb=p[h.charCodeAt(n++)],this.reverb=t.p(0,i.reverbRange,this.reverb);else if(97==y)this.beatsPerBar=u?[6,7,8,9,10][p[h.charCodeAt(n++)]]:p[h.charCodeAt(n++)]+1,this.beatsPerBar=Math.max(i.beatsPerBarMin,Math.min(i.beatsPerBarMax,this.beatsPerBar));else if(103==y){this.barCount=(p[h.charCodeAt(n++)]<<6)+p[h.charCodeAt(n++)]+1,this.barCount=Math.max(i.barCountMin,Math.min(i.barCountMax,this.barCount));for(var S=0;S<this.getChannelCount();S++){for(var k=this.channels[S].bars.length;k<this.barCount;k++)this.channels[S].bars[k]=1;this.channels[S].bars.length=this.barCount}}else if(106==y){this.patternsPerChannel=p[h.charCodeAt(n++)]+1,this.patternsPerChannel=Math.max(i.patternsPerChannelMin,Math.min(i.patternsPerChannelMax,this.patternsPerChannel));for(var O=0;O<this.getChannelCount();O++){for(var E=this.channels[O].patterns.length;E<this.patternsPerChannel;E++)this.channels[O].patterns[E]=new a;this.channels[O].patterns.length=this.patternsPerChannel}}else if(105==y){this.instrumentsPerChannel=p[h.charCodeAt(n++)]+1,this.instrumentsPerChannel=Math.max(i.instrumentsPerChannelMin,Math.min(i.instrumentsPerChannelMax,this.instrumentsPerChannel));for(var P=0;P<this.getChannelCount();P++){for(var I=this.channels[P].instruments.length;I<this.instrumentsPerChannel;I++)this.channels[P].instruments[I]=new o;if(this.channels[P].instruments.length=this.instrumentsPerChannel,d)for(I=0;I<this.instrumentsPerChannel;I++)this.channels[P].instruments[I].setTypeAndReset(P<this.pitchChannelCount?0:2)}}else if(114==y)this.partsPerBeat=i.partCounts[p[h.charCodeAt(n++)]];else if(111==y)if(u)g=p[h.charCodeAt(n++)],this.channels[g].octave=t.p(0,5,p[h.charCodeAt(n++)]);else for(g=0;g<this.getChannelCount();g++)this.channels[g].octave=t.p(0,5,p[h.charCodeAt(n++)]);else if(84==y){++w>=this.instrumentsPerChannel&&(m++,w=0),this.channels[m].instruments[w].setTypeAndReset(t.p(0,3,p[h.charCodeAt(n++)]))}else if(119==y)if(u)g=p[h.charCodeAt(n++)],this.channels[g].instruments[0].wave=t.p(0,i.waveNames.length,p[h.charCodeAt(n++)]);else if(d)for(g=0;g<this.getChannelCount();g++)for(var A=g>=this.pitchChannelCount,D=0;D<this.instrumentsPerChannel;D++)this.channels[g].instruments[D].wave=t.p(0,A?i.drumNames.length:i.waveNames.length,p[h.charCodeAt(n++)]);else{A=m>=this.pitchChannelCount;this.channels[m].instruments[w].wave=t.p(0,A?i.drumNames.length:i.waveNames.length,p[h.charCodeAt(n++)])}else if(102==y)if(u)g=p[h.charCodeAt(n++)],this.channels[g].instruments[0].filter=[1,3,4,5][t.p(0,i.filterNames.length,p[h.charCodeAt(n++)])];else if(d)for(g=0;g<this.getChannelCount();g++)for(D=0;D<this.instrumentsPerChannel;D++)this.channels[g].instruments[D].filter=t.p(0,i.filterNames.length,p[h.charCodeAt(n++)]+1);else this.channels[m].instruments[w].filter=t.p(0,i.filterNames.length,p[h.charCodeAt(n++)]);else if(100==y)if(u)g=p[h.charCodeAt(n++)],this.channels[g].instruments[0].transition=t.p(0,i.transitionNames.length,p[h.charCodeAt(n++)]);else if(d)for(g=0;g<this.getChannelCount();g++)for(D=0;D<this.instrumentsPerChannel;D++)this.channels[g].instruments[D].transition=t.p(0,i.transitionNames.length,p[h.charCodeAt(n++)]);else this.channels[m].instruments[w].transition=t.p(0,i.transitionNames.length,p[h.charCodeAt(n++)]);else if(99==y)if(u){g=p[h.charCodeAt(n++)];var F=t.p(0,i.effectNames.length,p[h.charCodeAt(n++)]);1==F?F=3:3==F&&(F=5),this.channels[g].instruments[0].effect=F}else if(d)for(g=0;g<this.getChannelCount();g++)for(D=0;D<this.instrumentsPerChannel;D++)this.channels[g].instruments[D].effect=t.p(0,i.effectNames.length,p[h.charCodeAt(n++)]);else this.channels[m].instruments[w].effect=t.p(0,i.effectNames.length,p[h.charCodeAt(n++)]);else if(104==y)if(u)g=p[h.charCodeAt(n++)],this.channels[g].instruments[0].chorus=t.p(0,i.chorusNames.length,p[h.charCodeAt(n++)]);else if(d)for(g=0;g<this.getChannelCount();g++)for(D=0;D<this.instrumentsPerChannel;D++)this.channels[g].instruments[D].chorus=t.p(0,i.chorusNames.length,p[h.charCodeAt(n++)]);else this.channels[m].instruments[w].chorus=t.p(0,i.chorusNames.length,p[h.charCodeAt(n++)]);else if(118==y)if(u)g=p[h.charCodeAt(n++)],this.channels[g].instruments[0].volume=t.p(0,i.volumeNames.length,p[h.charCodeAt(n++)]);else if(d)for(g=0;g<this.getChannelCount();g++)for(D=0;D<this.instrumentsPerChannel;D++)this.channels[g].instruments[D].volume=t.p(0,i.volumeNames.length,p[h.charCodeAt(n++)]);else this.channels[m].instruments[w].volume=t.p(0,i.volumeNames.length,p[h.charCodeAt(n++)]);else if(65==y)this.channels[m].instruments[w].algorithm=t.p(0,i.operatorAlgorithmNames.length,p[h.charCodeAt(n++)]);else if(70==y)this.channels[m].instruments[w].feedbackType=t.p(0,i.operatorFeedbackNames.length,p[h.charCodeAt(n++)]);else if(66==y)this.channels[m].instruments[w].feedbackAmplitude=t.p(0,i.operatorAmplitudeMax+1,p[h.charCodeAt(n++)]);else if(86==y)this.channels[m].instruments[w].feedbackEnvelope=t.p(0,i.operatorEnvelopeNames.length,p[h.charCodeAt(n++)]);else if(81==y)for(var T=0;T<i.operatorCount;T++)this.channels[m].instruments[w].operators[T].frequency=t.p(0,i.operatorFrequencyNames.length,p[h.charCodeAt(n++)]);else if(80==y)for(T=0;T<i.operatorCount;T++)this.channels[m].instruments[w].operators[T].amplitude=t.p(0,i.operatorAmplitudeMax+1,p[h.charCodeAt(n++)]);else if(69==y)for(T=0;T<i.operatorCount;T++)this.channels[m].instruments[w].operators[T].envelope=t.p(0,i.operatorEnvelopeNames.length,p[h.charCodeAt(n++)]);else if(98==y){var R=void 0;if(u){g=p[h.charCodeAt(n++)];var B=p[h.charCodeAt(n++)];R=Math.ceil(.5*B);var U=new s(p,h,n,n+R);for(D=0;D<B;D++)this.channels[g].bars[D]=U.read(3)+1}else if(c){for(var Y=0;1<<Y<this.patternsPerChannel;)Y++;R=Math.ceil(this.getChannelCount()*this.barCount*Y/6);U=new s(p,h,n,n+R);for(g=0;g<this.getChannelCount();g++)for(D=0;D<this.barCount;D++)this.channels[g].bars[D]=U.read(Y)+1}else{for(Y=0;1<<Y<this.patternsPerChannel+1;)Y++;R=Math.ceil(this.getChannelCount()*this.barCount*Y/6);U=new s(p,h,n,n+R);for(g=0;g<this.getChannelCount();g++)for(D=0;D<this.barCount;D++)this.channels[g].bars[D]=U.read(Y)}n+=R}else if(112==y){var C=0;if(u)g=p[h.charCodeAt(n++)],n++,C=p[h.charCodeAt(n++)],C<<=6,C+=p[h.charCodeAt(n++)];else{g=0;for(var z=p[h.charCodeAt(n++)];z>0;)C<<=6,C+=p[h.charCodeAt(n++)],z--}U=new s(p,h,n,n+C);n+=C;for(var j=0;1<<j<this.instrumentsPerChannel;)j++;for(;;){var q=this.getChannelIsDrum(g),N=q?0:12*this.channels[g].octave,G=null,W=null,H=(q?4:12)+N,L=q?[4,6,7,2,3,8,0,10]:[12,19,24,31,36,7,0],J=[];for(D=0;D<L.length;D++)L[D]+=N;for(D=0;D<this.patternsPerChannel;D++){var _=this.channels[g].patterns[D];if(_.reset(),_.instrument=U.read(j),u||0!=U.read(1))for(var K=0,Q=_.notes;K<this.beatsPerBar*this.partsPerBeat;){var V=1==U.read(1),X=!1,Z=0;if(V?Z=U.readLongTail(0,0):X=1==U.read(1),V||X){var $=void 0,tt=void 0,it=void 0;if(V)$=J[Z],J.splice(Z,1);else{for(($={}).pitchCount=1;$.pitchCount<4&&1==U.read(1);)$.pitchCount++;$.pinCount=U.readPinCount(),$.initialVolume=U.read(2),$.pins=[],$.length=0,$.bendCount=0;for(var st=0;st<$.pinCount;st++)(tt={}).pitchBend=1==U.read(1),tt.pitchBend&&$.bendCount++,$.length+=U.readPartDuration(),tt.time=$.length,tt.volume=U.read(2),$.pins.push(tt)}J.unshift($),J.length>10&&J.pop(),(G=e(0,K,K+$.length,$.initialVolume)).pitches=[],G.pins.length=1;var ht=[];for(st=0;st<$.pitchCount+$.bendCount;st++){if(1==U.read(1)){var rt=U.read(3);it=L[rt],L.splice(rt,1)}else{var et=U.readPitchInterval();it=H;for(var at=et;at>0;){for(it++;-1!=L.indexOf(it);)it++;at--}for(;at<0;){for(it--;-1!=L.indexOf(it);)it--;at++}}L.unshift(it),L.length>8&&L.pop(),st<$.pitchCount?G.pitches.push(it):ht.push(it),H=st==$.pitchCount-1?G.pitches[0]:it}ht.unshift(G.pitches[0]);for(var nt=0,ot=$.pins;nt<ot.length;nt++){var ft=ot[nt];ft.pitchBend&&ht.shift(),W=r(ht[0]-G.pitches[0],ft.time,ft.volume),G.pins.push(W)}K=G.end,Q.push(G)}else{K+=U.readPartDuration()}}}if(u)break;if(++g>=this.getChannelCount())break}}}}}else this.fromJsonObject(JSON.parse(0==n?h:h.substring(n)))}else this.initToDefault(!0)},t.prototype.toJsonObject=function(s,h,r){void 0===s&&(s=!0),void 0===h&&(h=1),void 0===r&&(r=!0);for(var e=[],a=0;a<this.getChannelCount();a++){for(var n=[],o=this.getChannelIsDrum(a),f=0;f<this.instrumentsPerChannel;f++){var l=this.channels[a].instruments[f];if(2==l.type)n.push({type:i.instrumentTypeNames[l.type],volume:20*(5-l.volume),wave:i.drumNames[l.wave],transition:i.transitionNames[l.transition]});else if(0==l.type)n.push({type:i.instrumentTypeNames[l.type],volume:20*(5-l.volume),wave:i.waveNames[l.wave],transition:i.transitionNames[l.transition],filter:i.filterNames[l.filter],chorus:i.chorusNames[l.chorus],effect:i.effectNames[l.effect]});else{if(1!=l.type)throw new Error("Unrecognized instrument type");for(var u=[],v=0,c=l.operators;v<c.length;v++){var d=c[v];u.push({frequency:i.operatorFrequencyNames[d.frequency],amplitude:d.amplitude,envelope:i.operatorEnvelopeNames[d.envelope]})}n.push({type:i.instrumentTypeNames[l.type],transition:i.transitionNames[l.transition],effect:i.effectNames[l.effect],algorithm:i.operatorAlgorithmNames[l.algorithm],feedbackType:i.operatorFeedbackNames[l.feedbackType],feedbackAmplitude:l.feedbackAmplitude,feedbackEnvelope:i.operatorEnvelopeNames[l.feedbackEnvelope],operators:u})}}for(var p=[],M=0,b=this.channels[a].patterns;M<b.length;M++){for(var m=b[M],w=[],y=0,g=m.notes;y<g.length;y++){for(var x=g[y],S=[],k=0,O=x.pins;k<O.length;k++){var E=O[k];S.push({tick:E.time+x.start,pitchBend:E.interval,volume:Math.round(100*E.volume/3)})}w.push({pitches:x.pitches,points:S})}p.push({instrument:m.instrument+1,notes:w})}var P=[];if(s)for(f=0;f<this.loopStart;f++)P.push(this.channels[a].bars[f]);for(var I=0;I<h;I++)for(f=this.loopStart;f<this.loopStart+this.loopLength;f++)P.push(this.channels[a].bars[f]);if(r)for(f=this.loopStart+this.loopLength;f<this.barCount;f++)P.push(this.channels[a].bars[f]);e.push({type:o?"drum":"pitch",octaveScrollBar:this.channels[a].octave,instruments:n,patterns:p,sequence:P})}return{format:t.M,version:t.l,scale:i.scaleNames[this.scale],key:i.keyNames[this.key],introBars:this.loopStart,loopBars:this.loopLength,beatsPerBar:this.beatsPerBar,ticksPerBeat:this.partsPerBeat,beatsPerMinute:this.getBeatsPerMinute(),reverb:this.reverb,channels:e}},t.prototype.fromJsonObject=function(s){if((this.initToDefault(!0),s)&&!(s.version>t.M)){if(this.scale=11,void 0!=s.scale){var h={"romani :)":8,"romani :(":9},n=void 0!=h[s.scale]?h[s.scale]:i.scaleNames.indexOf(s.scale);-1!=n&&(this.scale=n)}if(void 0!=s.key)if("number"==typeof s.key)this.key=i.keyNames.length-1-(s.key+1200>>>0)%i.keyNames.length;else if("string"==typeof s.key){var l=s.key,u=l.charAt(0).toUpperCase(),v=l.charAt(1).toLowerCase(),c={C:11,D:9,E:7,F:6,G:4,A:2,B:0}[u],d={"#":-1,"♯":-1,b:1,"♭":1}[v];void 0!=c&&(void 0!=d&&(c+=d),c<0&&(c+=12),c%=12,this.key=c)}if(void 0!=s.beatsPerMinute){var p=0|s.beatsPerMinute;this.tempo=Math.round(4+9*Math.log(p/120)/Math.LN2),this.tempo=t.p(0,i.tempoSteps,this.tempo)}void 0!=s.reverb&&(this.reverb=t.p(0,i.reverbRange,0|s.reverb)),void 0!=s.beatsPerBar&&(this.beatsPerBar=Math.max(i.beatsPerBarMin,Math.min(i.beatsPerBarMax,0|s.beatsPerBar))),void 0!=s.ticksPerBeat&&(this.partsPerBeat=0|s.ticksPerBeat,-1==i.partCounts.indexOf(this.partsPerBeat)&&(this.partsPerBeat=i.partCounts[i.partCounts.length-1]));var M=1,b=1,m=1;if(s.channels)for(var w=0,y=s.channels;w<y.length;w++){(k=y[w]).instruments&&(M=Math.max(M,0|k.instruments.length)),k.patterns&&(b=Math.max(b,0|k.patterns.length)),k.sequence&&(m=Math.max(m,0|k.sequence.length))}this.instrumentsPerChannel=M,this.patternsPerChannel=b,this.barCount=m,void 0!=s.introBars&&(this.loopStart=t.p(0,this.barCount,0|s.introBars)),void 0!=s.loopBars&&(this.loopLength=t.p(1,this.barCount-this.loopStart+1,0|s.loopBars));var g=0,x=0;if(s.channels)for(var S=0;S<s.channels.length;S++){var k=s.channels[S];this.channels.length<=S&&(this.channels[S]=new f),void 0!=k.octaveScrollBar&&(this.channels[S].octave=t.p(0,5,0|k.octaveScrollBar));for(var O=this.channels[S].instruments.length;O<this.instrumentsPerChannel;O++)this.channels[S].instruments[O]=new o;this.channels[S].instruments.length=this.instrumentsPerChannel;for(O=this.channels[S].patterns.length;O<this.patternsPerChannel;O++)this.channels[S].patterns[O]=new a;this.channels[S].patterns.length=this.patternsPerChannel;for(O=0;O<this.barCount;O++)this.channels[S].bars[O]=1;this.channels[S].bars.length=this.barCount;var E=!1;(E=k.type?"drum"==k.type:S>=3)?x++:g++;for(O=0;O<this.instrumentsPerChannel;O++){var P=this.channels[S].instruments[O],I=void 0;k.instruments&&(I=k.instruments[O]),void 0==I&&(I={});var A={binary:0},D=I.transition||I.envelope;if(P.transition=void 0!=A[D]?A[D]:i.transitionNames.indexOf(D),-1==P.transition&&(P.transition=1),P.type=i.instrumentTypeNames.indexOf(I.type),-1==P.type&&(P.type=E?2:0),2==P.type)void 0!=I.volume?P.volume=t.p(0,i.volumeNames.length,Math.round(5-(0|I.volume)/20)):P.volume=0,P.wave=i.drumNames.indexOf(I.wave),-1==P.wave&&(P.wave=1);else if(0==P.type){void 0!=I.volume?P.volume=t.p(0,i.volumeNames.length,Math.round(5-(0|I.volume)/20)):P.volume=0,P.wave=i.waveNames.indexOf(I.wave),-1==P.wave&&(P.wave=1);var F={"sustain sharp":1,"sustain medium":2,"sustain soft":3,"decay sharp":4};P.filter=void 0!=F[I.filter]?F[I.filter]:i.filterNames.indexOf(I.filter),-1==P.filter&&(P.filter=0),P.chorus=i.chorusNames.indexOf(I.chorus),-1==P.chorus&&(P.chorus=0),P.effect=i.effectNames.indexOf(I.effect),-1==P.effect&&(P.effect=0)}else{if(1!=P.type)throw new Error("Unrecognized instrument type.");P.effect=i.effectNames.indexOf(I.effect),-1==P.effect&&(P.effect=0),P.algorithm=i.operatorAlgorithmNames.indexOf(I.algorithm),-1==P.algorithm&&(P.algorithm=0),P.feedbackType=i.operatorFeedbackNames.indexOf(I.feedbackType),-1==P.feedbackType&&(P.feedbackType=0),void 0!=I.feedbackAmplitude?P.feedbackAmplitude=t.p(0,i.operatorAmplitudeMax+1,0|I.feedbackAmplitude):P.feedbackAmplitude=0,P.feedbackEnvelope=i.operatorEnvelopeNames.indexOf(I.feedbackEnvelope),-1==P.feedbackEnvelope&&(P.feedbackEnvelope=0);for(var T=0;T<i.operatorCount;T++){var R=P.operators[T],B=void 0;I.operators&&(B=I.operators[T]),void 0==B&&(B={}),R.frequency=i.operatorFrequencyNames.indexOf(B.frequency),-1==R.frequency&&(R.frequency=0),void 0!=B.amplitude?R.amplitude=t.p(0,i.operatorAmplitudeMax+1,0|B.amplitude):R.amplitude=0,R.envelope=i.operatorEnvelopeNames.indexOf(B.envelope),-1==R.envelope&&(R.envelope=0)}}}for(O=0;O<this.patternsPerChannel;O++){var U=this.channels[S].patterns[O],Y=void 0;if(k.patterns&&(Y=k.patterns[O]),void 0!=Y&&(U.instrument=t.p(0,this.instrumentsPerChannel,(0|Y.instrument)-1),Y.notes&&Y.notes.length>0)){var C=Math.min(this.beatsPerBar*this.partsPerBeat,Y.notes.length>>>0),z=0;for(T=0;T<Y.notes.length&&!(T>=C);T++){var j=Y.notes[T];if(j&&j.pitches&&j.pitches.length>=1&&j.points&&j.points.length>=2){var q=e(0,0,0,0);q.pitches=[],q.pins=[];for(var N=0;N<j.pitches.length;N++){var G=0|j.pitches[N];if(-1==q.pitches.indexOf(G)&&(q.pitches.push(G),q.pitches.length>=4))break}if(!(q.pitches.length<1)){var W=z,H=0;for(N=0;N<j.points.length;N++){var L=j.points[N];if(void 0!=L&&void 0!=L.tick){var J=void 0==L.pitchBend?0:0|L.pitchBend,_=0|L.tick,K=void 0==L.volume?3:Math.max(0,Math.min(3,Math.round(3*(0|L.volume)/100)));if(!(_>this.beatsPerBar*this.partsPerBeat)){if(0==q.pins.length){if(_<W)continue;q.start=_,H=J}else if(_<=W)continue;W=_,q.pins.push(r(J-H,_-q.start,K))}}}if(!(q.pins.length<2)){q.end=q.pins[q.pins.length-1].time+q.start;var Q=E?i.drumCount-1:i.maxPitch,V=Q,X=0;for(N=0;N<q.pitches.length;N++)q.pitches[N]+=H,(q.pitches[N]<0||q.pitches[N]>Q)&&(q.pitches.splice(N,1),N--),q.pitches[N]<V&&(V=q.pitches[N]),q.pitches[N]>X&&(X=q.pitches[N]);if(!(q.pitches.length<1)){for(N=0;N<q.pins.length;N++){var Z=q.pins[N];Z.interval+V<0&&(Z.interval=-V),Z.interval+X>Q&&(Z.interval=Q-X),N>=2&&Z.interval==q.pins[N-1].interval&&Z.interval==q.pins[N-2].interval&&Z.volume==q.pins[N-1].volume&&Z.volume==q.pins[N-2].volume&&(q.pins.splice(N-1,1),N--)}U.notes.push(q),z=q.end}}}}}}}for(O=0;O<this.barCount;O++)this.channels[S].bars[O]=k.sequence?Math.min(this.patternsPerChannel,k.sequence[O]>>>0):0}this.pitchChannelCount=g,this.drumChannelCount=x,this.channels.length=this.getChannelCount()}},t.p=function(t,i,s){return s<=(i-=1)?s>=t?s:t:i},t.prototype.getPattern=function(t,i){var s=this.channels[t].bars[i];return 0==s?null:this.channels[t].patterns[s-1]},t.prototype.getPatternInstrument=function(t,i){var s=this.getPattern(t,i);return null==s?0:s.instrument},t.prototype.getBeatsPerMinute=function(){return Math.round(120*Math.pow(2,(-4+this.tempo)/9))},t.M="BeepBox",t.v=2,t.l=6,t.u=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,62,62,0,0,1,2,3,4,5,6,7,8,9,0,0,0,0,0,0,0,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,0,0,0,0,63,0,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,0,0,0,0,0],t.o=[48,49,50,51,52,53,54,55,56,57,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,45,95],t}();t.Song=l;var u=function(){function t(){this.active=!1,this.sample=0,this.phases=[],this.phaseDeltas=[],this.volumeStarts=[],this.volumeDeltas=[],this.phaseDeltaScale=0,this.filter=0,this.filterScale=0,this.vibratoScale=0,this.harmonyMult=0,this.harmonyVolumeMult=1,this.feedbackOutputs=[],this.feedbackMult=0,this.feedbackDelta=0,this.reset()}return t.prototype.reset=function(){for(var t=0;t<i.operatorCount;t++)this.phases[t]=0,this.feedbackOutputs[t]=0;this.sample=0},t}(),v=function(){function s(t){void 0===t&&(t=null);var i=this;this.samplesPerSecond=44100,this.effectDuration=.14,this.effectAngle=2*Math.PI/(this.effectDuration*this.samplesPerSecond),this.effectYMult=2*Math.cos(this.effectAngle),this.limitDecay=1/(2*this.samplesPerSecond),this.song=null,this.pianoPressed=!1,this.pianoPitch=[0],this.pianoChannel=0,this.enableIntro=!0,this.enableOutro=!1,this.loopCount=-1,this.volume=1,this.playheadInternal=0,this.bar=0,this.beat=0,this.part=0,this.arpeggio=0,this.arpeggioSampleCountdown=0,this.paused=!0,this.tones=[],this.stillGoing=!1,this.effectPhase=0,this.limit=0,this.samplesForReverb=null,this.reverbDelayLine=new Float32Array(16384),this.reverbDelayPos=0,this.reverbFeedback0=0,this.reverbFeedback1=0,this.reverbFeedback2=0,this.reverbFeedback3=0,this.audioCtx=null,this.scriptNode=null,this.audioProcessCallback=function(t){var s=t.outputBuffer,h=s.getChannelData(0);i.synthesize(h,s.length)},null!=t&&this.setSong(t)}return s.warmUpSynthesizer=function(t){if(null!=t)for(var h=0;h<t.instrumentsPerChannel;h++){for(var r=t.pitchChannelCount;r<t.pitchChannelCount+t.drumChannelCount;r++)i.getDrumWave(t.channels[r].instruments[h].wave);for(r=0;r<t.getChannelCount();r++)s.getGeneratedSynthesizer(t.channels[r].instruments[h])}},s.operatorAmplitudeCurve=function(t){return(Math.pow(16,t/15)-1)/15},Object.defineProperty(s.prototype,"playing",{get:function(){return!this.paused},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"playhead",{get:function(){return this.playheadInternal},set:function(t){if(null!=this.song){this.playheadInternal=Math.max(0,Math.min(this.song.barCount,t));var i=this.playheadInternal;this.bar=Math.floor(i),i=this.song.beatsPerBar*(i-this.bar),this.beat=Math.floor(i),i=this.song.partsPerBeat*(i-this.beat),this.part=Math.floor(i),i=4*(i-this.part),this.arpeggio=Math.floor(i);var s=this.getSamplesPerArpeggio();i=s*(i-this.arpeggio),this.arpeggioSampleCountdown=Math.floor(s-i),this.bar<this.song.loopStart&&(this.enableIntro=!0),this.bar>this.song.loopStart+this.song.loopLength&&(this.enableOutro=!0)}},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"totalSamples",{get:function(){if(null==this.song)return 0;var t=4*this.getSamplesPerArpeggio()*this.song.partsPerBeat*this.song.beatsPerBar,i=this.loopCount;i<0&&(i=1);var s=this.song.loopLength*i;return this.enableIntro&&(s+=this.song.loopStart),this.enableOutro&&(s+=this.song.barCount-(this.song.loopStart+this.song.loopLength)),s*t},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"totalSeconds",{get:function(){return this.totalSamples/this.samplesPerSecond},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"totalBars",{get:function(){return null==this.song?0:this.song.barCount},enumerable:!0,configurable:!0}),s.prototype.setSong=function(t){"string"==typeof t?this.song=new l(t):t instanceof l&&(this.song=t)},s.prototype.play=function(){if(this.paused){this.paused=!1,s.warmUpSynthesizer(this.song);var t=window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.oAudioContext||window.msAudioContext;this.audioCtx=this.audioCtx||new t,this.scriptNode=this.audioCtx.createScriptProcessor?this.audioCtx.createScriptProcessor(2048,0,1):this.audioCtx.createJavaScriptNode(2048,0,1),this.scriptNode.onaudioprocess=this.audioProcessCallback,this.scriptNode.channelCountMode="explicit",this.scriptNode.channelInterpretation="speakers",this.scriptNode.connect(this.audioCtx.destination),this.samplesPerSecond=this.audioCtx.sampleRate,this.effectAngle=2*Math.PI/(this.effectDuration*this.samplesPerSecond),this.effectYMult=2*Math.cos(this.effectAngle),this.limitDecay=1/(2*this.samplesPerSecond)}},s.prototype.pause=function(){this.paused||(this.paused=!0,this.scriptNode.disconnect(this.audioCtx.destination),this.audioCtx.close&&(this.audioCtx.close(),this.audioCtx=null),this.scriptNode=null)},s.prototype.snapToStart=function(){this.bar=0,this.enableIntro=!0,this.snapToBar()},s.prototype.snapToBar=function(t){void 0!==t&&(this.bar=t),this.playheadInternal=this.bar,this.beat=0,this.part=0,this.arpeggio=0,this.arpeggioSampleCountdown=0,this.effectPhase=0;for(var i=0,s=this.tones;i<s.length;i++){s[i].reset()}this.reverbDelayPos=0,this.reverbFeedback0=0,this.reverbFeedback1=0,this.reverbFeedback2=0,this.reverbFeedback3=0;for(var h=0;h<this.reverbDelayLine.length;h++)this.reverbDelayLine[h]=0},s.prototype.nextBar=function(){if(this.song){var t=this.bar;this.bar++,this.enableOutro?this.bar>=this.song.barCount&&(this.bar=this.enableIntro?0:this.song.loopStart):(this.bar>=this.song.loopStart+this.song.loopLength||this.bar>=this.song.barCount)&&(this.bar=this.song.loopStart),this.playheadInternal+=this.bar-t}},s.prototype.prevBar=function(){if(this.song){var t=this.bar;this.bar--,this.bar<0&&(this.bar=this.song.loopStart+this.song.loopLength-1),this.bar>=this.song.barCount&&(this.bar=this.song.barCount-1),this.bar<this.song.loopStart&&(this.enableIntro=!0),!this.enableOutro&&this.bar>=this.song.loopStart+this.song.loopLength&&(this.bar=this.song.loopStart+this.song.loopLength-1),this.playheadInternal+=this.bar-t}},s.prototype.synthesize=function(i,h){if(null!=this.song){var r=this.song.getChannelCount();for(G=this.tones.length;G<r;G++)this.tones[G]=new u;this.tones.length=r;var e=this.getSamplesPerArpeggio(),a=0,n=!1;(0==this.arpeggioSampleCountdown||this.arpeggioSampleCountdown>e)&&(this.arpeggioSampleCountdown=e),this.part>=this.song.partsPerBeat&&(this.beat++,this.part=0,this.arpeggio=0,this.arpeggioSampleCountdown=e),this.beat>=this.song.beatsPerBar&&(this.bar++,this.beat=0,this.part=0,this.arpeggio=0,this.arpeggioSampleCountdown=e,-1==this.loopCount&&(this.bar<this.song.loopStart&&!this.enableIntro&&(this.bar=this.song.loopStart),this.bar>=this.song.loopStart+this.song.loopLength&&!this.enableOutro&&(this.bar=this.song.loopStart))),this.bar>=this.song.barCount&&(this.enableOutro?(this.bar=0,this.enableIntro=!0,n=!0,this.pause()):this.bar=this.song.loopStart),this.bar>=this.song.loopStart&&(this.enableIntro=!1);var o=performance.now();for(G=0;G<h;)i[G++]=0,i[G++]=0,i[G++]=0,i[G++]=0;(null==this.samplesForReverb||this.samplesForReverb.length<h)&&(this.samplesForReverb=new Float32Array(h));var f=this.samplesForReverb;for(G=0;G<h;)f[G++]=0,f[G++]=0,f[G++]=0,f[G++]=0;for(;a<h&&!n;)for(;a<h;){for(var l=h-a,v=this.arpeggioSampleCountdown<=l?this.arpeggioSampleCountdown:l,c=0;c<this.song.getChannelCount();c++){var d=this.song.channels[c].instruments[this.song.getPatternInstrument(c,this.bar)];s.computeTone(this,this.song,c,e,v,d);var p=this.tones[c];if(p.active){var M=this.song.getChannelIsDrum(c)?i:f;s.getGeneratedSynthesizer(d)(this,M,a,v,p,d)}}if(a+=v,this.effectPhase=(this.effectPhase+this.effectAngle*v)%(2*Math.PI),this.arpeggioSampleCountdown-=v,this.arpeggioSampleCountdown<=0&&(this.arpeggio++,this.arpeggioSampleCountdown=e,4==this.arpeggio&&(this.arpeggio=0,this.part++,this.part==this.song.partsPerBeat&&(this.part=0,this.beat++,this.beat==this.song.beatsPerBar)))){this.beat=0,this.bar++,this.effectPhase=0,this.bar<this.song.loopStart?this.enableIntro||(this.bar=this.song.loopStart):this.enableIntro=!1,this.bar>=this.song.loopStart+this.song.loopLength&&(this.loopCount>0&&this.loopCount--,(this.loopCount>0||!this.enableOutro)&&(this.bar=this.song.loopStart)),this.bar>=this.song.barCount&&(this.bar=0,this.enableIntro=!0,n=!0,this.pause());break}}var b=+this.volume,m=this.reverbDelayLine,w=0|this.reverbDelayPos,y=+this.reverbFeedback0,g=+this.reverbFeedback1,x=+this.reverbFeedback2,S=+this.reverbFeedback3,k=.425*Math.pow(this.song.reverb/t.Config.reverbRange,.667),O=+this.limitDecay,E=+this.limit;for(G=0;G<h;G++){var P=f[G],I=w+3041&16383,A=w+6426&16383,D=w+10907&16383,F=m[w]+P,T=m[I],R=m[A],B=m[D],U=-F+T,Y=-F-T,C=-R+B,z=-R-B;y+=.5*((U+C)*k-y),g+=.5*((Y+z)*k-g),x+=.5*((U-C)*k-x),S+=.5*((Y-z)*k-S),m[I]=y,m[A]=g,m[D]=x,m[w]=S,w=w+1&16383;var j=i[G]+F+T+R+B,q=j<0?-j:j;E<q&&(E=q),i[G]=j/(.75*E+.25)*b,E-=O}this.reverbDelayPos=w,this.reverbFeedback0=y,this.reverbFeedback1=g,this.reverbFeedback2=x,this.reverbFeedback3=S,this.limit=E,this.playheadInternal=(((this.arpeggio+1-this.arpeggioSampleCountdown/e)/4+this.part)/this.song.partsPerBeat+this.beat)/this.song.beatsPerBar+this.bar;var N=performance.now()-o;h,N}else for(var G=0;G<h;G++)i[G]=0},s.computeOperatorEnvelope=function(t,s,h,r){switch(i.operatorEnvelopeType[t]){case 0:return r;case 1:return 1;case 4:var e=1/(1+s*i.operatorEnvelopeSpeed[t]);return i.operatorEnvelopeInverted[t]?1-e:e;case 5:return.5-.5*Math.cos(2*h*Math.PI*i.operatorEnvelopeSpeed[t]);case 2:return Math.max(1,2-10*s);case 3:var a=i.operatorEnvelopeSpeed[t],n=.25/Math.sqrt(a);return s<n?s/n:1/(1+(s-n)*a);default:throw new Error("Unrecognized operator envelope type.")}},s.computeTone=function(t,h,r,e,a,n){var o=h.getChannelIsDrum(r),f=t.tones[r],l=h.getPattern(r,t.bar),u=t.pianoPressed&&r==t.pianoChannel,v=o?i.drumBasePitches[n.wave]:i.keyTransposes[h.key],c=o?i.drumInterval:1,d=o?i.drumWaveIsSoft[n.wave]?24:60:48,p=4*e/t.samplesPerSecond,M=1/h.partsPerBeat;f.phaseDeltaScale=0,f.filter=1,f.filterScale=1,f.vibratoScale=0,f.harmonyMult=1,f.harmonyVolumeMult=1,f.active=!1;for(var b=0,m=t.arpeggio,w=t.arpeggioSampleCountdown,y=null,g=!0,x=0,S=0,k=1,O=1,E=0,P=0,I=0,A=0,D=0,F=0,T=0;T<i.operatorCount;T++)f.phaseDeltas[T]=0,f.volumeStarts[T]=0,f.volumeDeltas[T]=0;if(u)y=t.pianoPitch,k=O=1,E=P=1,g=!1;else if(null!=l){var R=t.part+t.beat*h.partsPerBeat,B=null,U=null,Y=null;for(T=0;T<l.notes.length;T++)if(l.notes[T].end<=R)U=l.notes[T];else if(l.notes[T].start<=R&&l.notes[T].end>R)B=l.notes[T];else if(l.notes[T].start>R){Y=l.notes[T];break}if(null!=B&&null!=U&&U.end!=B.start&&(U=null),null!=B&&null!=Y&&Y.start!=B.end&&(Y=null),null!=B){y=B.pitches,b=R-B.start;var C=void 0;for(C=1;C<B.pins.length-1&&!(B.pins[C].time+B.start>R);C++);var z=B.pins[C-1],j=B.pins[C],q=4*B.start,N=4*B.end,G=4*(B.start+z.time),W=4*(B.start+j.time),H=4*R+m,L=4*R+m+1,J=(H-G)/(W-G),_=(L-G)/(W-G),K=z.volume+(j.volume-z.volume)*J,Q=z.volume+(j.volume-z.volume)*_,V=1,X=1,Z=z.interval+(j.interval-z.interval)*J,$=z.interval+(j.interval-z.interval)*_,tt=z.time+(j.time-z.time)*J,it=z.time+(j.time-z.time)*_,st=tt,ht=it,rt=1-w/e,et=1-(w-a)/e;g=H+rt-q==0;var at=n.transition;H==q&&(0==at?g=!1:2==at?V=0:3==at&&(null==U?V=0:0==U.pins[U.pins.length-1].volume||0==B.pins[0].volume?V=0:(Z=.5*(U.pitches[0]+U.pins[U.pins.length-1].interval-B.pitches[0]),st=.5*U.pins[U.pins.length-1].time,g=!1))),L==N&&(0==at?null==Y&&B.start+j.time!=h.partsPerBeat*h.beatsPerBar&&(X=0):1==at||2==at?X=0:3==at&&(null==Y?X=0:0==B.pins[B.pins.length-1].volume||0==Y.pins[0].volume?X=0:($=.5*(Y.pitches[0]-B.pitches[0]+B.pins[B.pins.length-1].interval),ht*=.5))),x=Z+($-Z)*rt,S=Z+($-Z)*et,E=t.volumeConversion(K+(Q-K)*rt),P=t.volumeConversion(K+(Q-K)*et),k=V+(X-V)*rt,O=V+(X-V)*et,I=B.start+tt+(it-tt)*rt,A=B.start+tt+(it-tt)*et,D=st+(ht-st)*rt,F=st+(ht-st)*et}}if(null!=y){var nt=1/t.samplesPerSecond;if(f.active=!0,o||1!=n.type){bt=y[0];if(i.chorusHarmonizes[n.chorus]){var ot=0;2==y.length?ot=y[1]-y[0]:3==y.length?ot=y[1+(m>>1)]-y[0]:4==y.length&&(ot=y[(3==m?1:m)+1]-y[0]),f.harmonyMult=Math.pow(2,ot/12),f.harmonyVolumeMult=Math.pow(2,-ot/d)}else 2==y.length?bt=y[m>>1]:3==y.length?bt=y[3==m?1:m]:4==y.length&&(bt=y[m]);wt=(bt+x)*c,Pt=(bt+S)*c,yt=t.frequencyFromPitch(v+wt),Ot=Math.pow(2,-wt/d),Et=Math.pow(2,-Pt/d);o&&i.drumWaveIsSoft[n.wave]&&(f.filter=Math.min(1,yt*nt*i.drumPitchFilterMult[n.wave]));var ft=void 0;if(o)ft=.19*i.drumVolumes[n.wave];else{var lt=i.filterDecays[n.filter];f.filter=Math.pow(2,-lt*p*D);var ut=Math.pow(2,-lt*p*F);f.filterScale=Math.pow(ut/f.filter,1/a),ft=.135*i.waveVolumes[n.wave]*i.filterVolumes[n.filter]*i.chorusVolumes[n.chorus]}g&&!o&&f.reset(),f.phaseDeltas[0]=yt*nt;var vt=5==n.volume?0:Math.pow(2,-i.volumeValues[n.volume]);f.volumeStarts[0]=k*E*Ot*ft*vt;kt=O*P*Et*ft*vt;f.volumeDeltas[0]=(kt-f.volumeStarts[0])/a}else{var ct=1,dt=0,pt=i.operatorCarrierCounts[n.algorithm];for(T=0;T<i.operatorCount;T++){var Mt=i.operatorAssociatedCarrier[n.algorithm][T]-1,bt=y[T<y.length?T:Mt<y.length?Mt:0],mt=i.operatorFrequencies[n.operators[T].frequency],wt=(bt+x)*c+i.operatorCarrierChorus[Mt],yt=mt*t.frequencyFromPitch(v+wt)+i.operatorHzOffsets[n.operators[T].frequency];f.phaseDeltas[T]=yt*nt*i.sineWaveLength,g&&f.reset();var gt=s.operatorAmplitudeCurve(n.operators[T].amplitude),xt=gt*i.operatorAmplitudeSigns[n.operators[T].frequency],St=xt,kt=xt;if(T<pt){var Ot,Et,Pt=(bt+S)*c;St*=.03*(Ot=Math.pow(2,-wt/d))*k,kt*=.03*(Et=Math.pow(2,-Pt/d))*O,dt+=gt}else St*=1.5*i.sineWaveLength,kt*=1.5*i.sineWaveLength,ct*=1-Math.min(1,n.operators[T].amplitude/15);var It=n.operators[T].envelope;St*=s.computeOperatorEnvelope(It,p*D,M*I,E),kt*=s.computeOperatorEnvelope(It,p*F,M*A,P),f.volumeStarts[T]=St,f.volumeDeltas[T]=(kt-St)/a}var At=.3*i.sineWaveLength*n.feedbackAmplitude/15,Dt=At*s.computeOperatorEnvelope(n.feedbackEnvelope,p*D,M*I,E),Ft=At*s.computeOperatorEnvelope(n.feedbackEnvelope,p*F,M*A,P);f.feedbackMult=Dt,f.feedbackDelta=(Ft-f.feedbackMult)/a,ct*=1-n.feedbackAmplitude/15,ct*=1-Math.min(1,Math.max(0,dt-1)/2);for(T=0;T<pt;T++)f.volumeStarts[T]*=1+3*ct,f.volumeDeltas[T]*=1+3*ct}f.phaseDeltaScale=Math.pow(2,(S-x)*c/12/a),f.vibratoScale=b<i.effectVibratoDelays[n.effect]?0:Math.pow(2,i.effectVibratos[n.effect]/12)-1}else{o||f.reset();for(T=0;T<i.operatorCount;T++)f.phaseDeltas[0]=0,f.volumeStarts[0]=0,f.volumeDeltas[0]=0}},s.getGeneratedSynthesizer=function(t){if(1==t.type){var h=t.algorithm+"_"+t.feedbackType;if(void 0==s.fmSynthFunctionCache[h]){for(var r=[],e=0,a=s.fmSourceTemplate;e<a.length;e++){var n=a[e];if(-1!=n.indexOf("// CARRIER OUTPUTS")){if(1==t.type){for(var o=[],f=0;f<i.operatorCarrierCounts[t.algorithm];f++)o.push("operator"+f+"Scaled");r.push(n.replace("/*operator#Scaled*/",o.join(" + ")))}}else if(-1!=n.indexOf("// INSERT OPERATOR COMPUTATION HERE"))for(f=i.operatorCount-1;f>=0;f--)for(var l=0,u=s.operatorSourceTemplate;l<u.length;l++){var v=u[l];if(-1!=v.indexOf("/* + operator@Scaled*/")){for(var c="",d=0,p=i.operatorModulatedBy[t.algorithm][f];d<p.length;d++){c+=" + operator"+((y=p[d])-1)+"Scaled"}var M=i.operatorFeedbackIndices[t.feedbackType][f];if(M.length>0){c+=" + feedbackMult * (";for(var b=[],m=0,w=M;m<w.length;m++){var y=w[m];b.push("operator"+(y-1)+"Output")}c+=b.join(" + ")+")"}r.push(v.replace(/\#/g,f+"").replace("/* + operator@Scaled*/",c))}else r.push(v.replace(/\#/g,f+""))}else if(-1!=n.indexOf("#"))for(f=0;f<i.operatorCount;f++)r.push(n.replace(/\#/g,f+""));else r.push(n)}s.fmSynthFunctionCache[h]=new Function("synth","data","bufferIndex","runLength","tone","instrument",r.join("\n"))}return s.fmSynthFunctionCache[h]}if(0==t.type)return s.chipSynth;if(2==t.type)return s.noiseSynth;throw new Error("Unrecognized instrument type: "+t.type)},s.chipSynth=function(i,s,h,r,e,a){var n=+i.effectYMult,o=+Math.sin(i.effectPhase),f=+Math.sin(i.effectPhase-i.effectAngle),l=t.Config.waves[a.wave],u=+l.length,v=+Math.pow(2,-t.Config.filterBases[a.filter]),c=+t.Config.effectTremolos[a.effect],d=+Math.pow(2,(t.Config.chorusOffsets[a.chorus]+t.Config.chorusIntervals[a.chorus])/12),p=Math.pow(2,(t.Config.chorusOffsets[a.chorus]-t.Config.chorusIntervals[a.chorus])/12)*e.harmonyMult,M=e.harmonyVolumeMult*t.Config.chorusSigns[a.chorus];0==a.chorus&&(e.phases[1]=e.phases[0]);for(var b=p/d,m=e.phaseDeltas[0]*d,w=+e.phaseDeltaScale,y=+e.volumeStarts[0],g=+e.volumeDeltas[0],x=e.filter*v,S=+e.filterScale,k=+e.vibratoScale,O=e.phases[0]%1,E=e.phases[1]%1,P=+e.sample,I=h+r;h<I;){var A=1+k*o,D=1+c*(o-1),F=o;o=n*o-f,f=F,P+=((l[0|O*u]+l[0|E*u]*M)*y*D-P)*x,y+=g,O+=m*A,E+=m*A*b,x*=S,O-=0|O,E-=0|E,m*=w,s[h]+=P,h++}e.phases[0]=O,e.phases[1]=E,e.sample=P},s.noiseSynth=function(i,s,h,r,e,a){for(var n=t.Config.getDrumWave(a.wave),o=+e.phaseDeltas[0]/32768,f=+e.phaseDeltaScale,l=+e.volumeStarts[0],u=+e.volumeDeltas[0],v=+e.filter,c=e.phases[0]%1,d=+e.sample,p=h+r;h<p;)d+=(n[0|32768*c]*l-d)*v,l+=u,c+=o,c-=0|c,o*=f,s[h]+=d,h++;e.phases[0]=c,e.sample=d},s.prototype.frequencyFromPitch=function(t){return 440*Math.pow(2,(t-69)/12)},s.prototype.volumeConversion=function(t){return Math.pow(t/3,1.5)},s.prototype.getSamplesPerArpeggio=function(){if(null==this.song)return 0;var t=4*(this.song.getBeatsPerMinute()/60*this.song.partsPerBeat);return Math.floor(this.samplesPerSecond/t)},s.negativePhaseGuard=1e3,s.fmSynthFunctionCache={},s.fmSourceTemplate=("\n\t\t\t// TODO: Skip this line and oscillator below unless using an effect:\n\t\t\tvar effectYMult = +synth.effectYMult;\n\t\t\tvar effectY     = +Math.sin(synth.effectPhase);\n\t\t\tvar prevEffectY = +Math.sin(synth.effectPhase - synth.effectAngle);\n\t\t\t\n\t\t\tvar sineWave = beepbox.Config.sineWave;\n\t\t\t\n\t\t\tvar tremoloScale = +beepbox.Config.effectTremolos[instrument.effect];\n\t\t\t\n\t\t\tvar phaseDeltaScale = +tone.phaseDeltaScale;\n\t\t\tvar vibratoScale = +tone.vibratoScale;\n\t\t\tvar operator#Phase       = +((tone.phases[#] % 1) + "+s.negativePhaseGuard+") * "+i.sineWaveLength+";\n\t\t\tvar operator#PhaseDelta  = +tone.phaseDeltas[#];\n\t\t\tvar operator#OutputMult  = +tone.volumeStarts[#];\n\t\t\tvar operator#OutputDelta = +tone.volumeDeltas[#];\n\t\t\tvar operator#Output      = +tone.feedbackOutputs[#];\n\t\t\tvar feedbackMult         = +tone.feedbackMult;\n\t\t\tvar feedbackDelta        = +tone.feedbackDelta;\n\t\t\tvar sample = +tone.sample;\n\t\t\t\n\t\t\tvar stopIndex = bufferIndex + runLength;\n\t\t\twhile (bufferIndex < stopIndex) {\n\t\t\t\tvar vibrato = 1.0 + vibratoScale * effectY;\n\t\t\t\tvar tremolo = 1.0 + tremoloScale * (effectY - 1.0);\n\t\t\t\tvar temp = effectY;\n\t\t\t\teffectY = effectYMult * effectY - prevEffectY;\n\t\t\t\tprevEffectY = temp;\n\t\t\t\t\n\t\t\t\t// INSERT OPERATOR COMPUTATION HERE\n\t\t\t\tsample = tremolo * (/*operator#Scaled*/); // CARRIER OUTPUTS\n\t\t\t\tfeedbackMult += feedbackDelta;\n\t\t\t\toperator#OutputMult += operator#OutputDelta;\n\t\t\t\toperator#Phase += operator#PhaseDelta * vibrato;\n\t\t\t\toperator#PhaseDelta *= phaseDeltaScale;\n\t\t\t\t\n\t\t\t\tdata[bufferIndex] += sample;\n\t\t\t\tbufferIndex++;\n\t\t\t}\n\t\t\t\n\t\t\ttone.phases[#] = operator#Phase / "+i.sineWaveLength+";\n\t\t\ttone.feedbackOutputs[#] = operator#Output;\n\t\t\ttone.sample = sample;\n\t\t").split("\n"),s.operatorSourceTemplate=("\n\t\t\t\tvar operator#PhaseMix = operator#Phase/* + operator@Scaled*/;\n\t\t\t\tvar operator#PhaseInt = operator#PhaseMix|0;\n\t\t\t\tvar operator#Index    = operator#PhaseInt & "+i.sineWaveMask+";\n\t\t\t\tvar operator#Sample   = sineWave[operator#Index];\n\t\t\t\toperator#Output       = operator#Sample + (sineWave[operator#Index + 1] - operator#Sample) * (operator#PhaseMix - operator#PhaseInt);\n\t\t\t\tvar operator#Scaled   = operator#OutputMult * operator#Output;\n\t\t").split("\n"),s}();t.Synth=v}(beepbox||(beepbox={}));